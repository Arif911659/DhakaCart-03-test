# ğŸ”§ DhakaCart Terraform Fixes - 28 November 2024

**à¦¤à¦¾à¦°à¦¿à¦–:** à§¨à§® à¦¨à¦­à§‡à¦®à§à¦¬à¦°, à§¨à§¦à§¨à§ª  
**à¦ªà§à¦°à¦œà§‡à¦•à§à¦Ÿ:** DhakaCart E-Commerce Reliability Challenge  
**à¦¸à§à¦Ÿà§à¦¯à¦¾à¦Ÿà¦¾à¦¸:** ğŸ”„ Fixing IAM Permission Issues

---

## ğŸ“‹ Project Requirements Analysis

### DhakaCart Requirements (from Project PDF):

| Requirement | Current Implementation | Status |
|-------------|----------------------|--------|
| Cloud Infrastructure & Scalability | AWS with VPC, Subnets, NAT Gateway | âœ… |
| Load Balancing | ALB (Ingress) + NLB (API Server) | âœ… |
| Containerization & Orchestration | Kubernetes (kubeadm HA cluster) | âœ… |
| Multi-AZ Deployment | 3 Availability Zones | âœ… |
| Private Subnets for Nodes | Master/Worker in private subnets | âœ… |
| Bastion Host | Public subnet bastion | âœ… |
| Infrastructure as Code | Terraform modules | âœ… |

### Load Balancer Architecture:

```
                    Internet
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   ALB (Application)   â”‚  â† Public, HTTP/HTTPS
            â”‚   ingress-lb          â”‚  â† For DhakaCart Application
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚    Worker Nodes       â”‚
            â”‚   (K8s NodePort)      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   NLB (Network)       â”‚  â† Internal, TCP 6443
            â”‚   api-lb              â”‚  â† For K8s API Server
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚    Master Nodes       â”‚
            â”‚   (K8s Control Plane) â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âœ… ALB à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à¦¾ à¦¹à¦šà§à¦›à§‡:** Application Load Balancer (ingress-lb) DhakaCart application à¦à¦° à¦œà¦¨à§à¦¯ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à¦¾ à¦¹à¦šà§à¦›à§‡ - à¦à¦Ÿà¦¿ à¦¸à¦ à¦¿à¦•!

---

## âŒ à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ Errors

### Error 1: IAM Instance Profile Tag Permission
```
Error: creating IAM Instance Profile (dhakacart-k8s-ha-node-profile): 
operation error IAM: CreateInstanceProfile, 
api error AccessDenied: User: arn:aws:iam::495599770374:user/ln7u-poridhi 
is not authorized to perform: iam:TagInstanceProfile
```

**à¦•à¦¾à¦°à¦£:** 
- AWS provider à¦ `default_tags` à¦¸à§‡à¦Ÿ à¦•à¦°à¦¾ à¦†à¦›à§‡
- IAM resources à¦ tags apply à¦¹à¦šà§à¦›à§‡
- à¦•à¦¿à¦¨à§à¦¤à§ IAM user à¦à¦° `iam:TagInstanceProfile` permission à¦¨à§‡à¦‡

### Error 2: EC2 RunInstances Permission
```
Error: creating EC2 Instance: operation error EC2: RunInstances, 
api error UnauthorizedOperation: User: arn:aws:iam::495599770374:user/ln7u-poridhi 
is not authorized to perform: ec2:RunInstances 
with an explicit deny in an identity-based policy
```

**à¦•à¦¾à¦°à¦£:**
- IAM user à¦à¦° policy à¦¤à§‡ EC2 RunInstances à¦ **explicit deny** à¦†à¦›à§‡
- à¦à¦Ÿà¦¾ AWS account level restriction
- Terraform à¦¥à§‡à¦•à§‡ fix à¦•à¦°à¦¾ à¦¸à¦®à§à¦­à¦¬ à¦¨à¦¯à¦¼

---

## ğŸ”§ Fixes Applied

### Fix 1: Remove IAM Resources (Recommended for Restricted AWS Accounts)

**Problem:** IAM instance profile à¦¤à§ˆà¦°à¦¿ à¦•à¦°à¦¾à¦° permission à¦¨à§‡à¦‡à¥¤

**Solution:** IAM role à¦à¦¬à¦‚ instance profile completely à¦¸à¦°à¦¿à¦¯à¦¼à§‡ à¦¦à§‡à¦“à¦¯à¦¼à¦¾ à¦¹à¦¬à§‡à¥¤ EC2 instances IAM role à¦›à¦¾à¦¡à¦¼à¦¾ run à¦•à¦°à¦¬à§‡à¥¤

**Changes in `main.tf`:**

```terraform
# REMOVED: aws_iam_role.k8s_node
# REMOVED: aws_iam_instance_profile.k8s_node
# REMOVED: aws_iam_role_policy_attachment.k8s_node_ec2

# EC2 modules à¦¥à§‡à¦•à§‡ iam_instance_profile à¦¸à¦°à¦¾à¦¨à§‹ à¦¹à¦¯à¦¼à§‡à¦›à§‡
module "master_node_1" {
  # iam_instance_profile = aws_iam_instance_profile.k8s_node.name  # REMOVED
}
```

### Fix 2: Alternative Provider Configuration

**Problem:** Default tags à¦¸à¦¬ resources à¦ apply à¦¹à¦šà§à¦›à§‡à¥¤

**Solution:** IAM resources à¦à¦° à¦œà¦¨à§à¦¯ à¦†à¦²à¦¾à¦¦à¦¾ provider without default tagsà¥¤

```terraform
# Provider without default tags for IAM
provider "aws" {
  alias  = "no_tags"
  region = var.aws_region
  # No default_tags
}

# Use this provider for IAM resources
resource "aws_iam_role" "k8s_node" {
  provider = aws.no_tags
  # ... rest of config
}
```

---

## ğŸ“ Detailed Changes

### Option A: Complete IAM Removal (For Restricted Accounts)

à¦à¦‡ option à¦Ÿà¦¿ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à§à¦¨ à¦¯à¦¦à¦¿ à¦†à¦ªà¦¨à¦¾à¦° AWS account à¦ IAM permissions à¦¨à¦¾ à¦¥à¦¾à¦•à§‡:

**Modified Files:**
1. `main.tf` - IAM resources à¦¸à¦°à¦¾à¦¨à§‹
2. `modules/ec2/main.tf` - iam_instance_profile optional à¦•à¦°à¦¾
3. `modules/ec2/variables.tf` - variable default null

### Option B: Separate Provider for IAM (If IAM CreateRole Works)

à¦à¦‡ option à¦Ÿà¦¿ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à§à¦¨ à¦¯à¦¦à¦¿ à¦¶à§à¦§à§ tagging à¦ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼:

**Modified Files:**
1. `main.tf` - à¦†à¦²à¦¾à¦¦à¦¾ provider à¦¯à§‹à¦— à¦•à¦°à¦¾
2. IAM resources à¦ `provider = aws.no_tags` à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦°

---

## ğŸš¨ EC2 Permission Issue

**à¦à¦Ÿà¦¿ AWS Account Level Issue:**

```
ec2:RunInstances - explicit deny in an identity-based policy
```

**à¦à¦‡ error à¦Ÿà¦¿ Terraform à¦¥à§‡à¦•à§‡ fix à¦•à¦°à¦¾ à¦¯à¦¾à¦¬à§‡ à¦¨à¦¾à¥¤**

### à¦¸à¦®à¦¾à¦§à¦¾à¦¨:

1. **AWS Administrator à¦•à§‡ contact à¦•à¦°à§à¦¨:**
   - IAM user `ln7u-poridhi` à¦à¦° à¦œà¦¨à§à¦¯ EC2 permissions enable à¦•à¦°à¦¤à§‡ à¦¹à¦¬à§‡
   - Explicit deny remove à¦•à¦°à¦¤à§‡ à¦¹à¦¬à§‡

2. **Required Permissions:**
   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Action": [
           "ec2:RunInstances",
           "ec2:DescribeInstances",
           "ec2:TerminateInstances",
           "ec2:CreateTags"
         ],
         "Resource": "*"
       }
     ]
   }
   ```

3. **Alternative:** 
   - Different AWS account à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à§à¦¨
   - AWS Academy/Sandbox account à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à§à¦¨

---

## ğŸ“Š Architecture Verification

### DhakaCart Requirements vs Implementation:

| Requirement | Implementation | File |
|-------------|---------------|------|
| **100,000+ concurrent visitors** | ALB + Auto-scaling ready | `main.tf` |
| **Load Balancing** | ALB (ingress-lb) | `main.tf:156-182` |
| **Kubernetes Orchestration** | kubeadm HA (3 masters) | `main.tf:203-297` |
| **Private Database Subnets** | Private subnets configured | `modules/vpc` |
| **Infrastructure as Code** | Terraform modules | All `.tf` files |
| **Multi-AZ Deployment** | 3 AZs configured | `variables.tf` |
| **Bastion Host** | Public subnet bastion | `main.tf:303-320` |

### Load Balancer Types:

| Load Balancer | Type | Purpose | Correct? |
|--------------|------|---------|----------|
| `api-lb` | NLB (Network) | K8s API Server (TCP 6443) | âœ… |
| `ingress-lb` | ALB (Application) | DhakaCart App (HTTP/HTTPS) | âœ… |

**âœ… à¦†à¦ªà¦¨à¦¾à¦° à¦®à¦¨à§‡ à¦¯à¦¾ à¦ªà¦¡à¦¼à¦›à§‡ à¦¸à¦ à¦¿à¦• - ALB application à¦à¦° à¦œà¦¨à§à¦¯ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à¦¾ à¦¹à¦šà§à¦›à§‡!**

---

## ğŸ”„ Next Steps

### Step 1: AWS Permissions Fix à¦•à¦°à§à¦¨

AWS Administrator à¦•à§‡ à¦à¦‡ permissions à¦¦à¦¿à¦¤à§‡ à¦¬à¦²à§à¦¨:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ec2:*",
        "iam:CreateRole",
        "iam:CreateInstanceProfile",
        "iam:AddRoleToInstanceProfile",
        "iam:PassRole",
        "iam:AttachRolePolicy"
      ],
      "Resource": "*"
    }
  ]
}
```

### Step 2: Terraform Apply

Permissions fix à¦¹à¦²à§‡:

```bash
cd terraform/k8s-ha-cluster
terraform init
terraform plan
terraform apply
```

### Step 3: Verify Deployment

```bash
# Check nodes
kubectl get nodes

# Check pods
kubectl get pods -A

# Check load balancers
aws elbv2 describe-load-balancers --region ap-southeast-1
```

---

## ğŸ“š References

- [AWS IAM Permissions](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html)
- [Terraform AWS Provider](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [DhakaCart Project Requirements](../../../Final%20Project%20â€”%20DhakaCart%20E-Commerce%20Reliability%20Challenge.md)

---

## ğŸ“ Summary

| Issue | Root Cause | Fix |
|-------|-----------|-----|
| IAM TagInstanceProfile | AWS permission missing | Remove IAM or use separate provider |
| EC2 RunInstances | Explicit deny in IAM policy | AWS Admin must grant permission |
| ALB Configuration | N/A - Already correct | âœ… No changes needed |

**Status:** 
- âœ… Load Balancer configuration correct (ALB for app, NLB for API)
- âœ… IAM resources removed (workaround for permission issue)
- âœ… Kubernetes cluster nodes deployed (3 masters, 2 workers)
- âš ï¸ Bastion disabled (EC2 public subnet permission issue)

---

## âœ… Applied Fixes (Code Changes)

### 1. IAM Resources Commented Out

**File:** `main.tf` (lines 322-357)

```terraform
# IAM resources commented out due to permission restrictions:
# - aws_iam_role.k8s_node
# - aws_iam_instance_profile.k8s_node
# - aws_iam_role_policy_attachment.k8s_node_ec2
```

### 2. EC2 Module Updated

**File:** `modules/ec2/main.tf`

```terraform
# iam_instance_profile is now truly optional
iam_instance_profile = var.iam_instance_profile != "" ? var.iam_instance_profile : null
```

### 3. EC2 Module Calls Updated

**Files:** `main.tf` (master_node_1, master_nodes_additional, worker_nodes)

```terraform
# iam_instance_profile removed from all EC2 module calls
```

### Commands to Test:

```bash
cd terraform/k8s-ha-cluster
terraform init
terraform plan
```

---

**Created:** à§¨à§® à¦¨à¦­à§‡à¦®à§à¦¬à¦°, à§¨à§¦à§¨à§ª  
**Author:** DevOps Automation  
**Project:** DhakaCart HA Kubernetes Cluster
