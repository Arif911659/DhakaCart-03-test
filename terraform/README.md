# ЁЯПЧя╕П Infrastructure as Code (Terraform)

**ржПржЯрж┐ ржХрж┐? (What is this?)**
ржПржЯрж┐ AWS ржХрзНрж▓рж╛ржЙржбрзЗ ржЖржорж╛ржжрзЗрж░ рж╕ржорзНржкрзВрж░рзНржг ржЗржиржлрзНрж░рж╛рж╕рзНржЯрзНрж░рж╛ржХржЪрж╛рж░ (Server, Network, Storage, Load Balancer) ржЕржЯрзЛржорзЗржЯрж┐ржХ рждрзИрж░рж┐ ржХрж░рж╛рж░ "ржмрзНрж▓рзБржкрзНрж░рж┐ржирзНржЯ"ред ржЖржорж░рж╛ **Terraform** ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржЫрж┐ ржпрж╛рждрзЗ ржкрзБрж░рзЛ ржПржиржнрж╛рзЯрж░ржиржорзЗржирзНржЯ рззрзж ржорж┐ржирж┐ржЯрзЗрж░ ржХржо рж╕ржорзЯрзЗ рждрзИрж░рж┐ ржХрж░рж╛ ржпрж╛рзЯред

**ржХрзЗржи ржПржЯрж┐ ржжрж░ржХрж╛рж░? (Why do we need this?)**
- **Consistency**: ржорзНржпрж╛ржирзБрзЯрж╛рж▓рж┐ рж╕рж╛рж░рзНржнрж╛рж░ рж╕рзЗржЯржЖржк ржХрж░рж╛рж░ ржЭрж╛ржорзЗрж▓рж╛ ржУ ржнрзБрж▓ рж╣ржУрзЯрж╛рж░ ржХрзЛржирзЛ рж╕рзБржпрзЛржЧ ржирзЗржЗред
- **Speed**: ржПржХ ржХржорж╛ржирзНржбрзЗ VPC, Subnet, Security Group, EC2 ржПржмржВ Load Balancer рждрзИрж░рж┐ рж╣рзЯрзЗ ржпрж╛рзЯред
- **Predictability**: ржЖржорж╛ржжрзЗрж░ "Simple K8s" ржЖрж░рзНржХрж┐ржЯрзЗржХржЪрж╛рж░рзЗрж░ ржЬржирзНржп ржЖржорж░рж╛ **Fixed Private IPs** ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржЫрж┐, ржпрж╛рждрзЗ ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи рж╕рж╣ржЬ рж╣рзЯред

---

## тЪЩя╕П ржХрж┐ ржХрж┐ рждрзИрж░рж┐ рж╣рзЯ? (Resources Created)

ржЖржорж░рж╛ `simple-k8s` ржлрзЛрж▓рзНржбрж╛рж░рзЗрж░ ржХрзЛржб ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржЫрж┐ред

| Resource | Count | Spec | Internal IP (Fixed) | Purpose |
|----------|-------|------|-------------------|---------|
| **VPC** | 1 | 10.0.0.0/16 | - | Isolated Network |
| **Bastion** | 1 | t3.small | 10.0.1.10 | Secure Entry Point (Public) |
| **Master Nodes** | 2 | t3.medium | 10.0.10.10, 10.0.10.11 | Kubernetes Control Plane (Private) |
| **Worker Nodes** | 3 | t3.medium | 10.0.10.20 - 22 | Application Workload (Private) |
| **ALB** | 1 | App Load Balancer | - | Public Traffic Entry & Distribution |

**ЁЯТ░ Estimated Cost:** ~$0.30/hour (~$7.20/day)

---

## ЁЯУВ ржлрж╛ржЗрж▓ рж╕рзНржЯрзНрж░рж╛ржХржЪрж╛рж░ (File Structure)

```bash
terraform/simple-k8s/
тФЬтФАтФА main.tf                 # ЁЯПЧя╕П ржорзЗржЗржи ржЗржиржлрзНрж░рж╛рж╕рзНржЯрзНрж░рж╛ржХржЪрж╛рж░ ржХрзЛржб (VPC, EC2, SG)
тФЬтФАтФА alb-backend-config.tf   # ЁЯМР рж▓рзЛржб ржмрзНржпрж╛рж▓рзЗржирзНрж╕рж╛рж░ ржПржмржВ ржЯрж╛рж░рзНржЧрзЗржЯ ржЧрзНрж░рзБржк ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи
тФЬтФАтФА variables.tf            # ЁЯФз ржнрзЗрж░рж┐рзЯрзЗржмрж▓ (Region, AMI, Instance Type)
тФЬтФАтФА outputs.tf              # ЁЯУд ржЖржЙржЯржкрзБржЯ (Load Balancer DNS, IPs)
тФВ
тФЬтФАтФА ЁЯУВ nodes-config-steps/generated/ # тЪЩя╕П ржЕржЯрзЛ-ржЬрзЗржирж╛рж░рзЗржЯрзЗржб ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи (DO NOT EDIT)
тФВ   тФЬтФАтФА master-1.sh         # Master-1 ржЗржирж┐рж╢рж┐рзЯрж╛рж▓рж╛ржЗржЬрзЗрж╢ржи рж╕рзНржХрзНрж░рж┐ржкрзНржЯ (kubeadm init)
тФВ   тФЬтФАтФА master-2.sh         # Master-2 ржЬрзЯрзЗржи рж╕рзНржХрзНрж░рж┐ржкрзНржЯ
тФВ   тФФтФАтФА workers.sh          # Worker ржЬрзЯрзЗржи рж╕рзНржХрзНрж░рж┐ржкрзНржЯ
тФВ   # ржПржЧрзБрж▓рзЛ deploy-full-stack.sh рж░рж╛ржи ржХрж░рж╛рж░ рж╕ржорзЯ ржЕржЯрзЛржорзЗржЯрж┐ржХ рждрзИрж░рж┐ рж╣рзЯред
тФВ
тФЬтФАтФА ЁЯУВ scripts/             # ЁЯЫая╕П рж╣рзЗрж▓рзНржкрж╛рж░ рж╕рзНржХрзНрж░рж┐ржкрзНржЯрж╕
тФВ   тФЬтФАтФА post-apply.sh       # Terraform рж╢рзЗрж╖рзЗрж░ ржкрж░ K8s ржХржиржлрж┐ржЧрж╛рж░ ржЖржкржбрзЗржЯ ржХрж░рзЗ
тФВ   тФФтФАтФА update-configmap.sh # ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржирзЗрж░ ржХржиржлрж┐ржЧржорзНржпрж╛ржк ржЖржкржбрзЗржЯ ржХрж░рзЗ
тФВ
тФФтФАтФА register-workers-to-alb.sh # ЁЯдЦ Worker Node тЖТ ALB ржХрж╛ржирзЗржХрж╢ржи рж╕рзНржХрзНрж░рж┐ржкрзНржЯ
    # ржирждрзБржи Worker Node рждрзИрж░рж┐ рж╣рж▓рзЗ ржПржЯрж┐ рж░рж╛ржи ржХрж░рзЗ рждрж╛ржжрзЗрж░ржХрзЗ рж▓рзЛржб ржмрзНржпрж╛рж▓рзЗржирзНрж╕рж╛рж░рзЗ ржпрзБржХрзНржд ржХрж░рж╛ рж╣рзЯред
```

---

## ЁЯЪА ржХрж┐ржнрж╛ржмрзЗ рж░рж╛ржи ржХрж░ржмрзЗржи? (How to Run)

### ржкрзВрж░рзНржмрж╢рж░рзНржд (Prerequisites)
- AWS CLI ржХржиржлрж┐ржЧрж╛рж░ ржХрж░рж╛ ржерж╛ржХрждрзЗ рж╣ржмрзЗ (`aws configure`)
- Terraform ржЗржирж╕рзНржЯрж▓ ржХрж░рж╛ ржерж╛ржХрждрзЗ рж╣ржмрзЗ

### рзз. ржлрзЛрж▓рзНржбрж╛рж░рзЗ ржпрж╛ржи
```bash
cd terraform/simple-k8s
```

### рзи. ржЗржирж┐рж╢рж┐рзЯрж╛рж▓рж╛ржЗржЬ (Initialize)
ржкрзНрж░ржержоржмрж╛рж░ рж░рж╛ржи ржХрж░рж╛рж░ ржЖржЧрзЗ ржкрзНрж▓рж╛ржЧрж┐ржи ржбрж╛ржЙржирж▓рзЛржб ржХрж░рждрзЗ рж╣рзЯред
```bash
terraform init
```

### рзй. ржкрзНрж▓рзНржпрж╛ржи ржжрзЗржЦрж╛ (Plan) - *Recommended*
ржХрж┐ ржХрж┐ рждрзИрж░рж┐ рж╣ржмрзЗ рждрж╛ ржЖржЧрзЗ ржжрзЗржЦрзЗ ржирзЗржУрзЯрж╛ ржнрж╛рж▓рзЛред
```bash
terraform plan
```

### рзк. ржЕрзНржпрж╛ржкрзНрж▓рж╛ржЗ (Apply) - *Create Infrastructure*
рж╕ржмрж╢рзЗрж╖рзЗ ржЗржиржлрзНрж░рж╛рж╕рзНржЯрзНрж░рж╛ржХржЪрж╛рж░ рждрзИрж░рж┐ ржХрж░рждрзЗ:
```bash
terraform apply --auto-approve
```
> тП│ **рж╕ржорзЯ рж▓рж╛ржЧржмрзЗ:** ржкрзНрж░рж╛рзЯ рзл-рзо ржорж┐ржирж┐ржЯред

---

## ЁЯз╣ ржХрзНрж▓рж┐ржиржЖржк (Clean Up)

ржХрж╛ржЬ рж╢рзЗрж╖ рж╣рж▓рзЗ ржмрж┐рж▓ ржмрж╛ржБржЪрж╛ржирзЛрж░ ржЬржирзНржп ржЗржиржлрзНрж░рж╛рж╕рзНржЯрзНрж░рж╛ржХржЪрж╛рж░ ржбрж┐рж▓рж┐ржЯ ржХрж░рждрзЗ ржнрзБрж▓ржмрзЗржи ржирж╛ред

```bash
terraform destroy --auto-approve
```

---

## тЪая╕П Troubleshooting

1.  **Error: Error acquiring the state lock**
    - ржпржжрж┐ ржЖржЧрзЗрж░ ржХрзЛржирзЛ ржХржорж╛ржирзНржб ржЖржЯржХрзЗ ржЧрж┐рзЯрзЗ ржерж╛ржХрзЗред
    - `terraform force-unlock <LOCK_ID>`

2.  **Error: Instance limit exceeded**
    - ржЖржкржирж╛рж░ AWS ржЕрзНржпрж╛ржХрж╛ржЙржирзНржЯрзЗрж░ vCPU рж▓рж┐ржорж┐ржЯ ржЪрзЗржХ ржХрж░рзБржиред `t3.medium` ржПрж░ ржЬржирзНржп рзиржЯрж╛ vCPU рж▓рж╛ржЧрзЗред рзлржЯрж╛ ржЗржирж╕рзНржЯрзНржпрж╛ржирзНрж╕ = рззрзж vCPUред

3.  **Connection Timeout**
    - Bastion рж╣рзЛрж╕рзНржЯ ржерзЗржХрзЗ ржкрзНрж░рж╛ржЗржнрзЗржЯ ржирзЛржбрзЗ ржХрж╛ржирзЗржХрзНржЯ ржХрж░рждрзЗ `dhakacart-k8s-key.pem` ржХрж┐ (Key) ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред
