# Monitoring & Observability Implementation Plan (PLAN-2025-12-06)

## üéØ Goal
Complete the "Monitoring & Observability" architecture for the DhakaCart Kubernetes deployment, as required by the *DhakaCart E-Commerce Reliability Challenge* (`my-final-project.md`).

## üìä Gap Analysis

| Requirement | Current State (Docker Compose) | Current State (Kubernetes) | Gap |
|-------------|-------------------------------|---------------------------|-----|
| **Monitoring Tools** | Prometheus + Grafana configured in `monitoring/docker-compose.yml` | **Missing** from `k8s/` manifests | The live K8s app has no monitoring. |
| **Centralized Logging** | Loki + Promtail configured in `logging/docker-compose.yml` | **Missing** from `k8s/` manifests | No logs aggregated from K8s pods. |
| **Real-time Dashboards** | Configured for `localhost` services | Not configured for K8s Service Discovery | Need K8s-native discovery (ServiceMonitors or Annotations). |
| **Alerting** | AlertManager configured | **Missing** | No alerts for K8s events/failures. |
| **Integration** | Works for local docker-compose | Manual/Non-existent | Need `kubectl apply` compatible manifests. |

## üõ† Mitigation Plan

We will implement a complete **Kubernetes-native Monitoring & Logging Stack** to be deployed alongside the application.

### 1. Structure Organization
Create a new directory `k8s/monitoring` to house all observability manifests.

```
k8s/monitoring/
‚îú‚îÄ‚îÄ namespace.yaml           # Monitoring namespace
‚îú‚îÄ‚îÄ prometheus/              # Plan for 06 Dec 2025: Complete Monitoring & Observability

**Objective:** Deploy a full-stack Monitoring and Logging solution for DhakaCart on Kubernetes.

## 1. Prometheus Implementation (Metrics) ‚úÖ
- [x] Create Namespace `monitoring`.
- [x] Deploy Prometheus Server.
- [x] Deploy Node Exporter (DaemonSet) for hardware metrics.
- [x] Configure RBAC and Service Discovery.
- [x] Verify Access via ALB Path `/prometheus/`.

## 2. Grafana Implementation (Visualization) ‚úÖ
- [x] Deploy Grafana.
- [x] Configure Datasource (Prometheus, Loki).
- [x] Expose via ALB Path `/grafana/`.
- [x] Fix access issues (root_url, subpath, websocket).

## 3. Logging Implementation (Loki stack) ‚úÖ
- [x] Deploy Loki (Log Aggregator).
- [x] Deploy Promtail (Log Shipper) as DaemonSet.
- [x] configured Grafana to read logs from Loki.
- [x] Integrated into `deploy-prod.sh` for automation.

## 4. Documentation ‚úÖ
- [x] `README.md` updated.
- [x] `Organized_folder-files-06-12-2025.md` created.
- [x] `Project-Deployment-Steps-(06-12-2025).md` created.

---
**Status:** COMPLETED üöÄ
All components are implemented and automated.
```

### 2. Implementation Details

#### A. Prometheus (Metrics)
*   **Deployment**: 1 replica.
*   **ConfigMap**: `prometheus.yaml` updated to use `kubernetes_sd_configs` to scrape:
    *   **Pods**: `dhakacart-backend`, `dhakacart-frontend` (via annotations).
    *   **Services**: Redis, PostgreSQL (via exporters if sidecars/separate deployments added, or internal metrics).
    *   **Nodes**: `node-exporter` (DaemonSet).
*   **RBAC**: `ClusterRole` to allow Prometheus to list Pods/Services/Nodes.

#### B. Grafana (Visualization)
*   **Deployment**: 1 replica.
*   **Provisioning**: Auto-load Datasources (Prometheus, Loki) and Dashboards.
*   **Service**: `NodePort` or `LoadBalancer` (or Ingress) to make it accessible (e.g., `grafana.dhakacart.com` or port forwarding).
*   **Dashboards**:
    *   *Cluster Health*: CPU/Memory of nodes.
    *   *Application Performance*: Request Rate, Errors, Latency (from Backend/Frontend).
    *   *Business Metrics*: Orders placed (if custom metrics instrumented).

#### C. Loki & Promtail (Logging)
*   **Loki**: Deployment (StatefulSet preferred for persistence, but Deployment ok for prototype).
*   **Promtail**: **DaemonSet** running on *every node*. Mounts `/var/log/pods` to ship logs to Loki.
    *   This satisfies: "Aggregate logs from all servers... searches in last hour... specific customer".

#### D. Alerting
*   **AlertManager**: wired to Prometheus.
*   **Rules**:
    *   `HighCPU`: Node or Pod CPU > 80%.
    *   `InstanceDown`: Target down > 1 min.
    *   `HighErrorRate`: 5xx errors > 5%.

### 3. Verification Plan

1.  **Deploy Stack**:
    ```bash
    kubectl apply -f k8s/monitoring/
    ```
2.  **Verify Pods**:
    ```bash
    kubectl get pods -n monitoring
    ```
3.  **Access Grafana**:
    *   Port forward: `kubectl port-forward svc/grafana 3000:3000 -n monitoring`
    *   Login: `admin` / `dhakacart123`
4.  **Test Metrics**:
    *   Run `k6` load test: `./testing/load-tests/run-load-test.sh`
    *   Observe "Application Performance" dashboard spikes.
5.  **Test Logs**:
    *   Generate random error: `curl http://<ALB>/api/error-test`
    *   Search in Grafana Explore (Loki): `{app="dhakacart-backend"} |= "error"`

## üìù Deliverables checklist

- [ ] `k8s/monitoring` directory created.
- [ ] Kubernetes manifests for Prometheus, Grafana, Loki, Promtail, AlertManager defined.
- [ ] Dashboard JSONs exported and added to ConfigMaps.
- [ ] `DEPLOYMENT_GUIDE_2025-12-05.md` updated with "Monitoring" section.
